---
title: "èª²ç¨çŠ¶æ³ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—"
format: 
  dashboard: 
    theme: minty
    nav-buttons: 
      - icon: house-door-fill
        href: https://yo5uke.com/pages/software/
      - icon: github
        href: https://github.com/yo5uke/tax_status_heatmap
lang: ja
server: shiny
---

```{r}
#| context: setup

library(shiny)
library(shinyWidgets)
library(tidyverse)
library(sf)
library(leaflet)
source("helpers.R")
```

# {.sidebar}

```{r}
br()
helpText(
  "éƒ½é“åºœçœŒã”ã¨ã®æ‰€å¾—ç¨ã€æ³•äººç¨ã€æ¶ˆè²»ç¨é¡ã‚’ãƒãƒƒãƒ”ãƒ³ã‚°ã—ã¦ã„ã¾ã™ã€‚"
)

br()

selectInput("tax_type", "ç¨ã®ç¨®é¡", 
            choices = c("æ‰€å¾—ç¨ï¼ˆåˆè¨ˆï¼‰", "ç”³å‘Šæ‰€å¾—ç¨", "æºæ³‰æ‰€å¾—ç¨", "æ³•äººç¨", "æ¶ˆè²»ç¨"), 
            selected = "æ‰€å¾—ç¨ï¼ˆåˆè¨ˆï¼‰")

sliderTextInput("year", "è¡¨ç¤ºã™ã‚‹å¹´åº¦", 
                choices = seq(2007, 2022, by = 1), 
                selected = 2022, 
                grid = TRUE)

br()


div(
  style = "text-align: center;", 
  actionButton("show_source", "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿å‡ºå…¸ç­‰")
)
```


# ãƒ—ãƒ­ãƒƒãƒˆ

```{r}
leafletOutput("map")
```

```{r}
#| context: server

observeEvent(input$show_source, {
  showModal(modalDialog(
    title = "ğŸ“¦ ãƒ‡ãƒ¼ã‚¿å‡ºå…¸ãƒ»ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ»ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰", 
    HTML("
      <div style='line-height: 1.6; font-size: 95%;'>
        <h4>ğŸ“Š ãƒ‡ãƒ¼ã‚¿å‡ºå…¸</h4>
        <p>æœ¬ã‚¢ãƒ—ãƒªã§ã¯ã€ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚‚ã¨ã«ä½œæˆã—ã¦ã„ã¾ã™ã€‚</p>
        <ul style='padding-left: 20px;'>
          <li>
            å›½ç¨åºã€ç¨å‹™çµ±è¨ˆã€ï¼ˆ2007ï½2022å¹´ï¼‰ï¼š
            <a href='https://www.e-stat.go.jp/stat-search/files?page=1&toukei=00351010&tstat=000001043366' target='_blank'>
              e-Stat
            </a>
            ã‚ˆã‚Š
          </li>
          <li>
            å›½åœŸæ•°å€¤æƒ…å ±ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚µã‚¤ãƒˆï¼š
            2024å¹´1æœˆ1æ—¥æ™‚ç‚¹ã®
            <a href='https://www.nta.go.jp/publication/statistics/kokuzeicho/tokei.htm' target='_blank'>
            è¡Œæ”¿åŒºåŸŸãƒ‡ãƒ¼ã‚¿
            </a><br>
            â€» ãƒ‡ãƒ¼ã‚¿è»½é‡åŒ–ã®ãŸã‚ <code>rmapshaper::ms_simplify()</code> ã‚’ä½¿ç”¨ã—ã¦ç°¡ç´ åŒ–ã—ã¦ã„ã¾ã™ã€‚
          </li>
        </ul>

        <h4>ğŸ“ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹</h4>
        <p>
          ã“ã®ã‚¢ãƒ—ãƒªã¯ <strong>MITãƒ©ã‚¤ã‚»ãƒ³ã‚¹</strong> ã®ä¸‹ã§å…¬é–‹ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
          è‡ªç”±ã«åˆ©ç”¨ãƒ»æ”¹å¤‰ãŒå¯èƒ½ã§ã™ãŒã€è‘—ä½œæ¨©è¡¨ç¤ºã¨ãƒ©ã‚¤ã‚»ãƒ³ã‚¹æ–‡ã®ä¿æŒãŒå¿…è¦ã§ã™ã€‚
        </p>

        <h4>ğŸ”— ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰</h4>
        <p>
          GitHub ãƒªãƒã‚¸ãƒˆãƒªã¯ã“ã¡ã‚‰ï¼š<br>
          <a href='https://github.com/yo5uke/tax_revenue_heatmap' target='_blank'>
            https://github.com/yo5uke/tax_revenue_heatmap
          </a>
        </p>
      </div>
    "), 
    easyClose = TRUE, 
    footer = modalButton("é–‰ã˜ã‚‹"), 
    size = "l"
  ))
})

selected_col <- reactive({
  if (input$tax_type == "æ‰€å¾—ç¨ï¼ˆåˆè¨ˆï¼‰") {
    return("shotoku")
  } else if (input$tax_type == "ç”³å‘Šæ‰€å¾—ç¨") {
    return("shotokuShinkoku")
  } else if (input$tax_type == "æºæ³‰æ‰€å¾—ç¨") {
    return("shotokuGensen")
  } else if (input$tax_type == "æ³•äººç¨") {
    return("hojin")
  } else if (input$tax_type == "æ¶ˆè²»ç¨") {
    return("shohi")
  }
})

observe({
  req(input$tax_type, input$year)
  
  withProgress(message = "åœ°å›³ã‚’æ›´æ–°ä¸­...", value = 0, {
    
    incProgress(0.2, detail = "è©²å½“å¹´ã®ãƒ‡ãƒ¼ã‚¿ã‚’æŠ½å‡ºä¸­...")
    
    df_year <- df |> 
      filter(year == input$year)
    
    incProgress(0.2, detail = "è©²å½“å¤‰æ•°ã‚’æŠ½å‡ºä¸­...")
    
    col_name <- selected_col()
    
    df_selected <- df_year |> 
      mutate(val = .data[[col_name]])
    
    if (input$tax_type %in% c("æ‰€å¾—ç¨ï¼ˆåˆè¨ˆï¼‰", "æºæ³‰æ‰€å¾—ç¨")) {
      df_selected <- df_selected |> 
        mutate(val_bin = pmax(pmin(val, 10000000), 0))
    } else if (input$tax_type == "ç”³å‘Šæ‰€å¾—ç¨") {
      df_selected <- df_selected |> 
        mutate(val_bin = pmax(pmin(val, 500000), 0))
    } else  {
      df_selected <- df_selected |> 
        mutate(val_bin = pmax(pmin(val, 1000000), 0))
    }
    
    incProgress(0.2, detail = "ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆã‚’ä½œæˆä¸­")
    
    if (input$tax_type == "æ‰€å¾—ç¨ï¼ˆåˆè¨ˆï¼‰") {
      breaks <- c(0, 50000, 100000, 200000, 500000, 1000000, 5000000, 10000000)
    } else if (input$tax_type == "ç”³å‘Šæ‰€å¾—ç¨") {
      breaks <- c(0, 10000, 30000, 50000, 100000, 200000, 300000, 500000)
    } else if (input$tax_type == "æºæ³‰æ‰€å¾—ç¨") {
      breaks <- c(0, 50000, 100000, 200000, 500000, 1000000, 5000000, 10000000)
    } else if (input$tax_type == "æ³•äººç¨") {
      breaks <- c(0, 25000, 50000, 75000, 100000, 300000, 500000, 1000000)
    } else if (input$tax_type == "æ¶ˆè²»ç¨") {
      breaks <- c(0, 50000, 75000, 100000, 150000, 300000, 500000, 1000000)
    }
    
    if (max(df_selected$val, na.rm = TRUE) > max(breaks)) {
      breaks <- c(breaks, max(df_selected$val_bin, na.rm = TRUE) * 1.1)
    }
    
    pal <- colorBin("YlOrRd", domain = df_selected$val_bin, bins = breaks)
    
    legend_title <- case_when(
      input$tax_type == "æ‰€å¾—ç¨ï¼ˆåˆè¨ˆï¼‰" ~ 
        paste0("æ‰€å¾—ç¨ï¼ˆå˜ä½ï¼šç™¾ä¸‡å††ï¼‰<br>", input$year, "å¹´åº¦"), 
      input$tax_type == "ç”³å‘Šæ‰€å¾—ç¨" ~ 
        paste0("ç”³å‘Šæ‰€å¾—ç¨ï¼ˆå˜ä½ï¼šç™¾ä¸‡å††ï¼‰<br>", input$year, "å¹´åº¦"), 
      input$tax_type == "æºæ³‰æ‰€å¾—ç¨" ~ 
        paste0("æºæ³‰æ‰€å¾—ç¨ï¼ˆå˜ä½ï¼šç™¾ä¸‡å††ï¼‰<br>", input$year, "å¹´åº¦"), 
      input$tax_type == "æ³•äººç¨" ~ 
        paste0("æ³•äººç¨ï¼ˆå˜ä½ï¼šç™¾ä¸‡å††ï¼‰<br>", input$year, "å¹´åº¦"), 
      input$tax_type == "æ¶ˆè²»ç¨" ~ 
        paste0("æ¶ˆè²»ç¨ï¼ˆå˜ä½ï¼šç™¾ä¸‡å††ï¼‰<br>", input$year, "å¹´åº¦"), 
    )
    
    popup_text <- paste0(
      df_selected$name_pref, "<br>", input$year, "å¹´åº¦", "<br>", 
      input$tax_type, "ï¼š", format(df_selected$val, big.mark = ","), "ç™¾ä¸‡å††")
    
    leafletProxy("map", data = df_selected) |> 
      clearShapes() |> 
      clearControls() |> 
      addPolygons(
        fillColor = ~pal(val_bin), 
        color = "white", 
        weight = 1, 
        opacity = 1, 
        fillOpacity = .7, 
        label = df_selected$name_pref, 
        popup = popup_text
      ) |> 
      addLegend(
        pal = pal, 
        values = df_selected$val_bin, 
        title = legend_title, 
        position = "bottomright", 
        labFormat = function(type, cuts, p) {
          cuts <- as.numeric(cuts)
          n <- length(cuts)
          labels <- vector("character", n-1)
          for (i in 1:(n-2)) {
            labels[i] <- paste0(
              format(cuts[i], big.mark = ",", scientific = FALSE), 
              "ï½", 
              format(cuts[i+1], big.mark = ",", scientific = FALSE)
            )
          }
          labels[n-1] <- paste0(
            format(cuts[n-1], big.mark = ",", scientific = FALSE), 
            "ä»¥ä¸Š"
          )
          return(labels)
        }
      )
    
    incProgress(1.0, detail = "ã¾ã‚‚ãªãè¡¨ç¤ºã•ã‚Œã¾ã™")
  })
})

output$map <- renderLeaflet({
  leaflet() |> 
    addTiles() |> 
    setView(lng = 138.36834, lat = 38.01827, zoom = 6)
})
```
